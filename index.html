<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width,
               initial-scale=1.0,
               minimum-scale=0.5,
               maximum-scale=3.0,
               user-scalable=yes">

<title>Porky's Game - Carte</title>

<script src="js/jszip.min.js"></script>
<script src="js/localforage.min.js"></script>

<style>
/* ===== GRAFICA IDENTICA AL TABELLONE ===== */
body {
  font-family: Arial, sans-serif;
  text-align: center;
  min-height: 100vh;
  background:
    linear-gradient(rgba(215,175,90,.85), rgba(215,175,90,.85)),
    url("images/logo_splash.png") center/cover no-repeat;
}

h1 { color:#502369; margin-top:18px; }

button {
  padding:10px;
  margin:5px;
  font-size:16px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}

.btn { background:linear-gradient(145deg,#dfad24,#9b710e); color:#3b2500; }
.reset,.cancellaMazzo { background:linear-gradient(145deg,#b00b0b,#910101); color:#fff; }

.carta {
  width:180px;height:300px;margin:20px auto;border-radius:10px;
  background:
    radial-gradient(circle at top,rgba(255,215,120,.35),rgba(80,0,40,.9)),
    url("images/Nuovo_logo_carte.png") center/cover no-repeat;
  box-shadow:0 0 15px rgba(245,197,66,.4), inset 0 0 10px rgba(0,0,0,.5);
}

.carta img { width:100%; height:100%; object-fit:cover; border-radius:10px; }

.shuffle { animation: shake .5s infinite; }
@keyframes shake {
  0%{transform:rotateZ(0)}25%{transform:rotateY(180deg)}
  50%{transform:rotateX(-180deg)}75%{transform:rotateY(180deg)}
  100%{transform:rotateZ(0)}
}

.info { font-size:18px;color:#502369;font-weight:bold; }

input[type=file]{display:none;}

#modalOverlay {
  position:fixed; inset:0; background:rgba(0,0,0,.6);
  display:none; align-items:center; justify-content:center; z-index:9999;
}
#modalBox {
  background:#f9e0a7; border:4px solid #502369;
  border-radius:14px; padding:25px; min-width:280px;
  color:#502369;
}
</style>
</head>

<body>

<h1>Porky's Game – Carte</h1>

<div>
  <button class="btn" onclick="apriZip()">Carica mazzo</button>
  <button class="btn" onclick="imgInput.click()">Aggiungi carte</button>

  <input type="file" id="zipInput" accept=".zip" multiple>
  <input type="file" id="imgInput"
         accept="image/png,image/jpeg,image/jpg,image/webp,image/gif"
         multiple>
</div>

<div class="info">Carte nel mazzo: <span id="contatore">0</span></div>

<div id="cartaEstratta" class="carta"></div>

<div>
  <button class="btn" onclick="estraiCarta()">ESTRAI</button>
  <button class="reset" onclick="resetPartita()">RESET</button>
  <button class="cancellaMazzo" id="cancellaMazzoBtn">CANCELLA MAZZO</button>
</div>

<div style="margin-top:15px;">
  <button id="backBtn"
    style="padding:10px 15px;background:#01893a;color:white;border:none;border-radius:6px;">
    ⬅ Home Page
  </button>
</div>

<div id="modalOverlay">
  <div id="modalBox">
    <div id="modalText"></div><br>
    <button id="modalOk" class="reset">SI</button>
    <button id="modalCancel" class="btn">NO</button>
  </div>
</div>

<script>
localforage.config({ name:'PorkysGame', storeName:'mazzo_carte' });

let mazzo = [];
let mazzoCancellato = false;

const zipInput = document.getElementById("zipInput");
const imgInput = document.getElementById("imgInput");
const contatore = document.getElementById("contatore");
const cartaEstratta = document.getElementById("cartaEstratta");

/* ===== UTIL ===== */
function aggiornaContatore(){ contatore.textContent = mazzo.filter(c=>!c.estratta).length; }
function resetCarta(){ cartaEstratta.innerHTML=""; }
async function salva(){ await localforage.setItem("mazzo", mazzo); }

async function caricaCarte(){
  const salvato = await localforage.getItem("mazzo");
  if(Array.isArray(salvato) && salvato.length){
    mazzo = salvato;
    mazzoCancellato = false;
    aggiornaContatore();
  }
}

/* ===== BLOCCO CARICAMENTO ===== */
function checkCaricamento(){
  if(mazzo.length && !mazzoCancellato){
    customAlert("Devi prima cancellare il mazzo attuale");
    return false;
  }
  return true;
}

/* ===== ZIP ===== */
function apriZip(){
  if(!checkCaricamento()) return;
  zipInput.value="";
  zipInput.click();
}

zipInput.addEventListener("change", async ()=>{
  for(const file of zipInput.files){
    const zip = await JSZip.loadAsync(file);
    const imgs = Object.values(zip.files)
      .filter(f=>!f.dir && /\.(png|jpe?g|webp|gif)$/i.test(f.name));
    for(const img of imgs){
      const base64 = await img.async("base64");
      mazzo.push({ nome:img.name, img:`data:image/png;base64,${base64}`, estratta:false });
    }
  }
  mazzoCancellato = false;
  await salva(); aggiornaContatore(); resetCarta();
});

/* ===== IMMAGINI ===== */
imgInput.addEventListener("change", async ()=>{
  if(!checkCaricamento()) return;

  for(const file of imgInput.files){
    const r = new FileReader();
    await new Promise(res=>{
      r.onload=e=>{
        mazzo.push({ nome:file.name, img:e.target.result, estratta:false });
        res();
      };
      r.readAsDataURL(file);
    });
  }
  mazzoCancellato = false;
  await salva(); aggiornaContatore(); resetCarta();
});

/* ===== GIOCO ===== */
function estraiCarta(){
  const disp = mazzo.filter(c=>!c.estratta);
  if(!disp.length){ customAlert("Tutte le carte sono state estratte!"); return; }
  cartaEstratta.classList.add("shuffle");
  setTimeout(()=>{
    cartaEstratta.classList.remove("shuffle");
    const c = disp[Math.floor(Math.random()*disp.length)];
    c.estratta = true;
    cartaEstratta.innerHTML=`<img src="${c.img}">`;
    aggiornaContatore(); salva();
  },800);
}

function resetPartita(){
  mazzo.forEach(c=>c.estratta=false);
  resetCarta(); aggiornaContatore(); salva();
}

/* ===== CANCELLA ===== */
document.getElementById("cancellaMazzoBtn").onclick=()=>{
  customConfirm("Vuoi cancellare TUTTO il mazzo?")
  .then(ok=>{
    if(!ok) return;
    mazzo=[];
    mazzoCancellato=true;
    localforage.removeItem("mazzo");
    resetCarta(); aggiornaContatore();
  });
};

/* ===== MODAL ===== */
function customAlert(msg){
  modalText.textContent=msg;
  modalCancel.style.display="none";
  modalOverlay.style.display="flex";
  modalOk.onclick=()=>{ modalOverlay.style.display="none"; modalCancel.style.display="inline-block"; };
}
function customConfirm(msg){
  return new Promise(res=>{
    modalText.textContent=msg;
    modalOverlay.style.display="flex";
    modalOk.onclick=()=>{ modalOverlay.style.display="none"; res(true); };
    modalCancel.onclick=()=>{ modalOverlay.style.display="none"; res(false); };
  });
}

/* ===== HOME ===== */
document.getElementById("backBtn").onclick=()=>location.href="./index.html";

window.addEventListener("load", caricaCarte);
</script>

</body>
</html>
